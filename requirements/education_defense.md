# 守りの教育要件定義書

## 概要

本ドキュメントは、株式投資の素人ユーザーが**リスクを自分で判断できるように成長する**ための教育機能を、守りの視点から定義する。

### 基本方針
- 説教しない。**文脈に埋め込まれた学び**で自然にリテラシーを高める
- ずぼらユーザーに負担をかけない。**痛みを伴わない疑似体験**で実感させる
- いつまでもツール任せにしない。**段階的に自立**させる
- 既存の守り機能（defense.md）のアラート・スコア・警告を「教材」として活用する

---

## 1. リスクリテラシーの成長ステージ定義

### 1.1 ステージ概要

| ステージ | 名称 | 状態 | ツールの振る舞い |
|----------|------|------|------------------|
| Lv.0 | **無知** | 用語もリスクもわからない。ツールに全てお任せ | 全ガードレールON。用語は全て平易な表現に置換。判断はツールが代行 |
| Lv.1 | **気づき** | 「危険な状態がある」ことを認識し始めた | アラートに「なぜ危険？」ボタンが出現。用語に触れる機会を増やす |
| Lv.2 | **理解** | 主要指標の意味を理解し、アラートの根拠を読める | 指標の数値をデフォルト表示に切り替え。シミュレーション機能を解放 |
| Lv.3 | **実践** | 自分でリスクを評価し、判断できる | ガードレールを「確認ダイアログ」に緩和。ツールは助言に徹する |
| Lv.4 | **習慣化** | リスク管理が日常的な判断の一部になった | ガードレールを最小限に。全設定のカスタマイズを解放 |

### 1.2 ステージ判定基準

ユーザーの行動ログから自動判定する。明示的な「テスト」は課さない（ずぼら対応）。

| 判定条件 | Lv.0→Lv.1 | Lv.1→Lv.2 | Lv.2→Lv.3 | Lv.3→Lv.4 |
|----------|------------|------------|------------|------------|
| アラートの「なぜ危険？」を3回以上開いた | 必須 | - | - | - |
| 用語解説を5種類以上閲覧した | 必須 | - | - | - |
| リスク指標の詳細画面を自主的に開いた | - | 必須 | - | - |
| シミュレーション機能を2回以上使用した | - | 必須 | - | - |
| 振り返りレポートを3回以上確認した | - | 必須 | - | - |
| 損切りルールを自分でカスタマイズした | - | - | 必須 | - |
| ガードレール警告に対し根拠ある判断をした（※） | - | - | 必須 | - |
| 3ヶ月間、健全度スコアを黄以上で維持した | - | - | - | 必須 |
| 自主的にポートフォリオを調整した実績が3回以上 | - | - | - | 必須 |

> ※「根拠ある判断」= ガードレール警告時に「理由を入力して続行」を選択し、理由が空でなかったケース

### 1.3 ステージの永続性と降格

- ステージは**降格しない**（一度理解した知識は失われない前提）
- ただし、**長期未ログイン（90日以上）の場合**、復帰時にリマインド画面を表示
  - 「お久しぶりです。市場環境が変わっています。ポートフォリオの状態を確認しましょう」
  - 強制的な降格はしないが、ガードレールを一時的に強化する選択肢を提示

---

## 2. 用語解説システム

### 2.1 基本方針
- 専門用語は**初出時に必ず平易な説明を添える**
- ユーザーのステージに応じて説明の深さを変える
- 「調べに行く」必要がない。**その場で理解できる**

### 2.2 用語解説レベル

#### Lv.0向け：平易な言い換え（デフォルト表示）

| 専門用語 | 平易な表現 | 補足 |
|----------|-----------|------|
| ボラティリティ | 値動きの激しさ | 「ジェットコースターのような株」 |
| ドローダウン | ピークからの下がり幅 | 「一番高かった時からどれだけ下がったか」 |
| シャープレシオ | リスクに見合ったリターンか | 「危険を冒した分だけ儲かっているか」 |
| β値（ベータ） | 市場全体との連動度 | 「市場が風邪をひいた時、この株はどのくらい影響を受けるか」 |
| VaR | 最悪ケースの想定損失額 | 「運が悪い日に、最大これくらい減るかも」 |
| HHI（集中度） | 偏り度合い | 「卵を一つのカゴに盛りすぎていないか」 |
| 相関係数 | 値動きの似ている度合い | 「一緒に上がって一緒に下がる関係かどうか」 |
| 含み損 | 買った時より下がっている金額 | 「今売ったらこれだけ損する」 |
| トレーリングストップ | 自動で引き上がる損切りライン | 「株価が上がるとき、安全ネットも一緒に上がる」 |
| リバランス | 配分の調整 | 「偏ったポートフォリオを元のバランスに戻す」 |

#### Lv.1向け：簡潔な定義 + 具体例

- ツールチップで表示
- 例：「ボラティリティ = 株価の変動の大きさ。過去20日間の日次リターンの標準偏差で計算。例：ボラティリティ30%の株は、1年間で±30%動く可能性がある」

#### Lv.2向け：正式な定義 + 計算式

- 「詳細を見る」リンクで展開
- 例：「ボラティリティ（σ）= 日次リターンの標準偏差 × √252。年率換算。この銘柄のσ=0.35は、年間35%の変動幅を持つことを意味する」

### 2.3 コンテキスト連動型解説

用語解説は**ユーザーが今見ている画面の文脈**に沿って出し分ける。

| 画面 | 表示される解説の文脈 |
|------|---------------------|
| 損切りアラート（F-D1） | 「含み損」「損切り」の解説。なぜこのラインが設定されているかの理由 |
| 健全度スコア（F-D2） | スコアの各構成要素の解説。「なぜこのスコアなのか」の内訳 |
| 集中リスク警告（F-D3） | 「集中度（HHI）」「分散投資」の解説。卵のカゴの比喩 |
| 暴落アラート（F-D4） | 「ボラティリティ」「β値」の解説。市場全体との関係 |
| 分散度チェッカー（F-D6） | 「相関係数」「セクター」の解説。分散の本当の意味 |

### 2.4 用語集ページ

- 全用語を一覧できるページを用意
- 検索機能付き
- ステージに応じて表示レベルを自動切り替え（Lv.0は平易版、Lv.2以上は正式版）
- 各用語に「この用語が関わる機能」へのリンクを付与

---

## 3. 「なぜ危険？」の説明機能

### 3.1 基本方針
- 全てのアラート・警告に**「なぜ危険？」ボタン**を付与
- ボタンを押すと、そのアラートが出た理由と根拠を表示
- ステージに応じて説明の深さを変える

### 3.2 アラートへの理由付与

既存の警告トリガー（defense.md 4.2節）に教育的な説明を追加する。

#### W-01: 個別銘柄が-5%/日

| ステージ | 説明内容 |
|----------|---------|
| Lv.0 | 「{銘柄}が1日で{X}%下がりました。普段の値動きより大きい下落です。何かニュースがあったかもしれません」 |
| Lv.1 | 「{銘柄}の1日の下落率{X}%は、この銘柄の平均的な日次変動（±{Y}%）の{Z}倍です。統計的に珍しい動きです」 |
| Lv.2 | 「{銘柄}の日次リターン{X}%は、過去60日のボラティリティ（σ={Y}%）に対して{Z}σの逸脱。95%信頼区間の外です」 |

#### W-02/W-03: 取得価格比で-10%/-15%

| ステージ | 説明内容 |
|----------|---------|
| Lv.0 | 「買った時より{X}%下がっています。このまま下がり続けると、損が大きくなります。損切り（一度売って損を確定すること）を検討する目安です」 |
| Lv.1 | 「含み損が{X}%に達しました。一般に、-10%を超えた銘柄が元の価格に戻るには+{Y}%の上昇が必要です（-10%→回復に+11.1%必要）。下がるほど回復は難しくなります」 |
| Lv.2 | 「含み損{X}%。回復に必要な上昇率は1/(1-X)-1={Y}%。過去データでは、-15%を超えた銘柄の{Z}%が6ヶ月以内に回復できていません」 |

#### W-04: 健全度スコア < 40

| ステージ | 説明内容 |
|----------|---------|
| Lv.0 | 「ポートフォリオ全体の安全度が低い状態です。特定の銘柄に偏っていたり、値動きの激しい銘柄が多いかもしれません」 |
| Lv.1 | 「健全度スコア{X}点。内訳：分散度{A}点、ボラティリティ{B}点、ドローダウン{C}点。特に{最低スコアの項目}が足を引っ張っています」 |
| Lv.2 | 「健全度{X}点の内訳と改善方向：分散度{A}（HHI={a}→目標<0.15）、ボラ{B}（σ={b}%→目標<20%）、MDD{C}（{c}%→目標>-10%）」 |

#### W-06/W-07: 集中リスク

| ステージ | 説明内容 |
|----------|---------|
| Lv.0 | 「一つの株（またはグループ）に偏りすぎています。その株が下がると、全体が大きく減ります。『卵を一つのカゴに盛るな』という格言があります」 |
| Lv.1 | 「{銘柄/セクター}が{X}%を占めています。もしこの部分が-20%下落すると、ポートフォリオ全体は-{Y}%の影響を受けます。分散していれば影響は-{Z}%に抑えられます」 |
| Lv.2 | 「集中度HHI={X}（理想は<0.15）。{銘柄}とポートフォリオ他銘柄の相関は{Y}。現在の構成でのVaR(95%)は{Z}円。5銘柄均等なら{W}円まで改善」 |

### 3.3 「もっと知りたい」リンク

各「なぜ危険？」の説明の末尾に、以下のリンクを配置：
- 「この状況をシミュレーションで体験する」→ セクション4のシミュレーション機能へ
- 「過去に似た状況を見る」→ セクション5の振り返り機能へ
- 「関連する用語を調べる」→ セクション2の用語集へ

---

## 4. シミュレーション/疑似体験

### 4.1 基本方針
- 実際のお金を使わず、**「もし〜だったら」を体験**できる
- ユーザーの実際のポートフォリオデータを使い、**自分ごと**にする
- ずぼらでも使えるよう、**ワンクリック**でシミュレーション開始

### 4.2 シミュレーションシナリオ

#### SIM-D1: 「もし損切りしなかったら」
- **トリガー**: 損切りアラート（W-02/W-03）発生時に提案
- **内容**: 過去の類似銘柄データを用いて、損切りしなかった場合のその後を表示
  - 「過去に同様の下落パターンだった{類似銘柄}は、その後{X}ヶ月で{Y}%まで下落しました」
  - グラフで視覚化：損切りした場合 vs しなかった場合の資産推移
- **ずぼら対応**: 「シミュレーションを見る」ボタン一つで表示

#### SIM-D2: 「もし集中投資を続けたら」
- **トリガー**: 集中リスク警告（W-06/W-07）発生時に提案
- **内容**: 現在のポートフォリオで特定銘柄/セクターが暴落した場合の影響を試算
  - 「もし{銘柄}が-30%下落したら、ポートフォリオ全体は-{X}%（{Y}円の損失）」
  - 「もし5銘柄に均等分散していたら、同じ事態でも-{Z}%（{W}円の損失）」
  - 円グラフで比較表示
- **ずぼら対応**: 集中リスク警告画面にインラインで表示

#### SIM-D3: 「もしリーマンショック級の暴落が来たら」
- **トリガー**: ポートフォリオ画面の「ストレステスト」ボタン
- **内容**: 過去の実際の暴落イベントを現在のポートフォリオに適用
  - リーマンショック（2008年）: 市場-50%
  - コロナショック（2020年）: 市場-30%
  - ITバブル崩壊（2000年）: テック銘柄-75%
- **表示**: 「あなたのポートフォリオは、リーマンショック級の暴落で{X}万円→{Y}万円（-{Z}%）になります」
- **ずぼら対応**: プリセットシナリオを選ぶだけ（パラメータ設定不要）

#### SIM-D4: 「分散の効果を体感する」
- **トリガー**: 分散度チェッカー（F-D6）画面で提案
- **内容**: 現在のポートフォリオ vs 理想的に分散したポートフォリオを過去データで比較
  - 過去1年間のリターンとリスク（ボラティリティ）を比較
  - 最大ドローダウンを比較
  - 「分散していれば、最悪期の下落は{X}%→{Y}%に抑えられていました」

### 4.3 シミュレーション結果の保存

- シミュレーション結果はユーザーのアカウントに保存（後で見返せる）
- 「予測 vs 実際」の追跡：シミュレーション実施後、実際にどうなったかを後日表示
  - 「3ヶ月前のシミュレーション通り、{銘柄}はさらに-{X}%下落しました」
  - これにより、シミュレーションの有用性を実感させる

---

## 5. 失敗から学ぶ仕組み

### 5.1 基本方針
- ユーザーの**実際の判断と結果**を記録し、振り返りの材料にする
- 「あの時こうしていれば」を**データで示す**
- 責めない。**事実を淡々と提示**し、気づきを促す

### 5.2 アラート無視の追跡

#### 追跡対象

全てのアラート（W-01〜W-10）について以下を記録：

| 記録項目 | 説明 |
|----------|------|
| アラート発生日時 | いつ警告が出たか |
| アラート内容 | 何について、どのレベルの警告だったか |
| ユーザーの対応 | 「対処した」「無視した」「既読のみ」 |
| 対応日時 | いつ対応したか（無視の場合はnull） |
| その後の結果 | アラート発生後の価格変動（7日後、30日後、90日後） |

#### データテーブル: alert_outcomes

| カラム | 型 | 説明 |
|--------|-----|------|
| id | INTEGER PK | レコードID |
| alert_id | INTEGER FK | アラートID（alerts.id） |
| user_action | TEXT | 対応種別（acted / ignored / read_only） |
| action_detail | TEXT | 具体的な対応内容（「A社を50%売却」等） |
| price_at_alert | REAL | アラート時の株価 |
| price_after_7d | REAL | 7日後の株価 |
| price_after_30d | REAL | 30日後の株価 |
| price_after_90d | REAL | 90日後の株価 |
| portfolio_impact | REAL | ポートフォリオ全体への影響額 |
| created_at | DATETIME | 記録作成日 |

### 5.3 振り返りレポート

#### 月次振り返り

月初に自動生成される「先月の振り返り」レポート。

**表示内容:**
1. **アラート対応サマリー**
   - 先月のアラート件数、対応率
   - 「対処したアラート」と「無視したアラート」の結果比較
2. **「もしアラートに従っていたら」の試算**
   - 無視したアラートについて、「あの時{アクション}していたら、{X}円の損失を回避できていました」
   - 逆に、無視して結果的に正しかったケースも公平に表示
3. **ポートフォリオの健全度推移**
   - 月間の健全度スコアのグラフ
   - スコアが下がった局面と、何が原因だったかの解説
4. **学びのサマリー**
   - 「今月わかったこと」を1〜2行で自動生成
   - 例：「損切りアラートを無視した2銘柄はさらに下落し、従った1銘柄は損失を限定できました」

#### 四半期振り返り

3ヶ月分のデータを統合した深い分析。

**表示内容:**
1. **判断パターンの分析**
   - 「あなたはセクター集中の警告を無視する傾向があります」
   - 「損切りアラートへの対応率は{X}%で、対応しなかった場合の平均追加損失は{Y}%でした」
2. **成長の可視化**
   - リスクリテラシーステージの変遷
   - 「この3ヶ月で用語解説を{X}回、シミュレーションを{Y}回利用しました」
3. **改善提案**
   - データに基づく具体的な改善ポイント
   - 「次の四半期は、集中リスク警告にもう少し注意してみましょう」

### 5.4 振り返りの「ずぼら」対応

- 振り返りレポートは自動生成（ユーザーの手間ゼロ）
- ダッシュボードのトップに「先月のハイライト」としてカード表示
- 詳細は「もっと見る」で展開
- 通知は月1回のみ（通知疲れ防止）

---

## 6. 段階的な権限解放

### 6.1 基本方針
- 初期状態はガードレール最強。ユーザーは守られている
- 理解が進むにつれ、**自由度を段階的に拡大**する
- 自由度の拡大は**ユーザー自身の選択**で行う（強制しない）

### 6.2 ステージ別のガードレール設定

#### Lv.0（無知）: フルガード

| 機能 | ガードレール |
|------|-------------|
| 損切りライン | 自動設定（-10%）。変更不可 |
| 集中度チェック | 30%超で**購入ブロック**（続行不可） |
| 健全度 < 40 | 新規購入**完全ブロック** |
| 高ボラ銘柄の購入 | β>1.5の銘柄は購入時に**警告+確認** |
| リスク指標の表示 | 平易な表現のみ。数値は非表示 |
| 設定変更 | 不可（全てデフォルト） |

#### Lv.1（気づき）: ガイド付き自由

| 機能 | ガードレール |
|------|-------------|
| 損切りライン | 自動設定（-10%）。**理由を入力すれば**変更可能（-5%〜-20%の範囲） |
| 集中度チェック | 30%超で**警告+確認ダイアログ**（理由入力で続行可能） |
| 健全度 < 40 | 新規購入時に**警告+確認ダイアログ** |
| 高ボラ銘柄の購入 | 警告表示。「なぜ危険？」解説付き |
| リスク指標の表示 | 平易な表現 + 数値を「詳細」で表示 |
| 設定変更 | 一部可能（損切りライン、通知レベル） |

#### Lv.2（理解）: 確認ベース

| 機能 | ガードレール |
|------|-------------|
| 損切りライン | 自由に設定可能（-3%〜-30%）。推奨値を表示 |
| 集中度チェック | 40%超で警告（30%では情報表示のみ） |
| 健全度 < 40 | 警告表示のみ（ブロックなし） |
| 高ボラ銘柄の購入 | 情報表示のみ（β値とボラティリティを表示） |
| リスク指標の表示 | 数値をデフォルト表示。計算式も閲覧可能 |
| 設定変更 | ほぼ全て可能（閾値の変更、通知ルール等） |

#### Lv.3（実践）: アドバイスのみ

| 機能 | ガードレール |
|------|-------------|
| 損切りライン | 完全カスタム。損切りなし設定も可能（警告付き） |
| 集中度チェック | 50%超で警告。それ以下は情報表示 |
| 健全度 < 40 | 情報表示のみ |
| 高ボラ銘柄の購入 | 制限なし |
| リスク指標の表示 | 全指標をデフォルト表示 |
| 設定変更 | 全て可能 |

#### Lv.4（習慣化）: フルカスタム

| 機能 | ガードレール |
|------|-------------|
| 全機能 | 全てのガードレールをON/OFF可能。独自ルール作成可能 |
| カスタムアラート | 任意の条件でアラートを作成可能 |
| 上級指標 | 効率的フロンティア、モンテカルロシミュレーション等を解放 |

### 6.3 権限解放の通知

ステージが上がった際の通知：

```
おめでとうございます！
リスクリテラシーがLv.{X}に上がりました。

新しくできるようになったこと：
- {解放された機能1}
- {解放された機能2}
- {解放された機能3}

引き続き、安全な投資を心がけましょう。
```

### 6.4 セーフティネット

権限解放後も、以下の最低限のセーフティネットは維持する：

- **Level 4（危険）アラートは全ステージで通知**（無効化不可）
- **ポートフォリオ全額が1銘柄**は全ステージで警告（分散の最低ライン）
- **市場全体の暴落通知**は全ステージで有効
- ステージに関わらず、全ガードレールをONに戻す「セーフモード」ボタンを常設

---

## 7. 教育コンテンツ管理

### 7.1 データテーブル: user_literacy

| カラム | 型 | 説明 |
|--------|-----|------|
| id | INTEGER PK | レコードID |
| user_id | INTEGER FK | ユーザーID |
| stage | INTEGER | 現在のリテラシーステージ（0〜4） |
| glossary_views | INTEGER | 用語解説の閲覧数 |
| why_dangerous_views | INTEGER | 「なぜ危険？」の閲覧数 |
| simulation_count | INTEGER | シミュレーション実行回数 |
| review_views | INTEGER | 振り返りレポートの閲覧数 |
| custom_rules_count | INTEGER | 自作ルールの数 |
| self_adjustments | INTEGER | 自主的なポートフォリオ調整回数 |
| healthy_months | INTEGER | 健全度スコア黄以上を維持した月数 |
| stage_updated_at | DATETIME | ステージ更新日時 |
| created_at | DATETIME | 作成日時 |

### 7.2 データテーブル: education_logs

| カラム | 型 | 説明 |
|--------|-----|------|
| id | INTEGER PK | ログID |
| user_id | INTEGER FK | ユーザーID |
| event_type | TEXT | イベント種別（glossary_view / why_dangerous / simulation / review 等） |
| target_id | TEXT | 対象ID（用語ID、アラートID、シミュレーションID等） |
| context | TEXT | 発生した画面/文脈 |
| created_at | DATETIME | 発生日時 |

### 7.3 データテーブル: simulation_results

| カラム | 型 | 説明 |
|--------|-----|------|
| id | INTEGER PK | シミュレーションID |
| user_id | INTEGER FK | ユーザーID |
| scenario_type | TEXT | シナリオ種別（stop_loss / concentration / stress_test / diversification） |
| parameters | JSON | シミュレーションパラメータ |
| result_summary | TEXT | 結果の要約テキスト |
| result_data | JSON | 結果の詳細データ |
| actual_outcome | JSON | 実際の結果（後日追記） |
| created_at | DATETIME | 実行日時 |

---

## 8. API エンドポイント概要

| メソッド | パス | 説明 |
|----------|------|------|
| GET | `/api/user/{id}/literacy` | ユーザーのリテラシーステージ取得 |
| GET | `/api/glossary` | 用語一覧取得（ステージに応じた表示レベル） |
| GET | `/api/glossary/{term}` | 個別用語の解説取得 |
| GET | `/api/alerts/{id}/explanation` | アラートの「なぜ危険？」解説取得 |
| POST | `/api/simulation/stop-loss` | 損切りシミュレーション実行 |
| POST | `/api/simulation/concentration` | 集中投資シミュレーション実行 |
| POST | `/api/simulation/stress-test` | ストレステスト実行 |
| POST | `/api/simulation/diversification` | 分散効果シミュレーション実行 |
| GET | `/api/simulation/{id}/result` | シミュレーション結果取得 |
| GET | `/api/user/{id}/review/monthly` | 月次振り返りレポート取得 |
| GET | `/api/user/{id}/review/quarterly` | 四半期振り返りレポート取得 |
| GET | `/api/alerts/{id}/outcome` | アラートのその後の結果取得 |
| GET | `/api/user/{id}/education-logs` | 教育ログ取得 |
| GET | `/api/user/{id}/guardrails` | 現在のガードレール設定取得 |
| PUT | `/api/user/{id}/guardrails` | ガードレール設定変更（ステージに応じた制限付き） |
| POST | `/api/user/{id}/safe-mode` | セーフモードON/OFF切り替え |

---

## 9. 既存機能との統合ポイント

本教育要件は、defense.md の既存機能を拡張する形で実装する。

| 既存機能 | 教育的拡張 |
|----------|-----------|
| F-D1: 損切りアラート | 「なぜ危険？」ボタン追加、SIM-D1（損切りシミュレーション）へのリンク |
| F-D2: 健全度スコア | ステージに応じた内訳表示の深さ切り替え、用語解説の組み込み |
| F-D3: 集中リスク警告 | SIM-D2（集中投資シミュレーション）へのリンク、分散の解説 |
| F-D4: 暴落アラート | SIM-D3（ストレステスト）へのリンク、市場全体の解説 |
| F-D5: リスク日次サマリー | ステージに応じた表示レベル切り替え |
| F-D6: 分散度チェッカー | SIM-D4（分散効果シミュレーション）の組み込み |
| F-D7: 損切りルール自動設定 | ステージに応じた変更権限の制御 |
| 警告ルール（W-01〜W-10） | 全警告に「なぜ危険？」と「その後の結果追跡」を追加 |
| ゼロコンフィグ設計 | Lv.0のフルガード状態がデフォルト |
| 段階的エスカレーション | アラート無視の追跡データとして活用 |
