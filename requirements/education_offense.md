# 攻めの教育要件定義書（利益を出せるユーザーに育てる）

## 概要

本ドキュメントは、株式投資の素人ユーザーが**自分で利益を出せる投資家に成長する**ための教育機能を、攻めの視点から定義する。「ずぼら」なユーザーが座学ではなく**実践の中で自然に学び**、段階的に自立した投資判断ができるようになることを目的とする。

### 設計原則

- **実践ファースト**: 教科書を読ませるのではなく、実際の投資行動の中で学ぶ
- **ジャストインタイム**: 必要なタイミングで、必要な知識だけを提示する
- **段階的開放**: 情報量を段階的に増やし、認知負荷を抑える
- **成功体験の蓄積**: 小さな成功を積み重ねて自信をつける
- **ずぼら互換**: 学ばなくてもツールは使える。学ぶとより上手く使える

---

## 1. 素人ユーザーの成長ステージ定義

### Stage 1: ビギナー（見習い投資家）
- **期間目安**: 利用開始〜3ヶ月
- **状態**: 投資用語がわからない。ツールの推奨をそのまま受け入れる
- **目標**: ツールの基本操作に慣れ、「株価は上がったり下がったりする」を体感する
- **昇格条件**:
  - ツールを30日以上利用（連続でなくてよい）
  - 最低3銘柄をウォッチリストに登録
  - 週次レポートを5回以上閲覧
  - 用語クイズ（後述）で基礎10問中7問正解

### Stage 2: アクティブ（実践投資家）
- **期間目安**: 3ヶ月〜1年
- **状態**: 基本用語を理解し、ツールの推奨理由をある程度読み解ける
- **目標**: シグナルの意味を理解し、ツールの推奨に対して「なるほど」と思える
- **昇格条件**:
  - ツールを累計90日以上利用
  - シグナル理由の「もっと詳しく」を10回以上閲覧
  - 自分でスクリーニング条件を1回以上カスタマイズ
  - 振り返りレポートで過去判断の分析を5回以上実施
  - 中級用語クイズで15問中10問正解

### Stage 3: ストラテジスト（自立投資家）
- **期間目安**: 1年〜
- **状態**: 指標の意味と使い方を理解し、自分の投資戦略を持てる
- **目標**: ツールを「参謀」として使いつつ、最終判断は自分でできる
- **到達指標**:
  - 独自のスクリーニング条件を作成・運用
  - バックテストを使って戦略を検証
  - 自分のポートフォリオの構成理由を説明できる

### ステージ判定の仕組み
- **自動判定**: 利用行動データに基づき、昇格条件を自動チェック
- **手動スキップ**: 「経験者です」ボタンで初回設定時にステージを自己申告可能
- **降格なし**: 一度上がったステージは下がらない（モチベーション維持）
- **ステージ表示**: ダッシュボード上部にアイコン+ステージ名で常時表示

---

## 2. 各ステージで見せる情報の段階設計

### 2.1 ダッシュボード表示の段階制御

| 表示要素 | Stage 1（ビギナー） | Stage 2（アクティブ） | Stage 3（ストラテジスト） |
|----------|---------------------|----------------------|--------------------------|
| 注目銘柄トップ5 | 銘柄名 + 一言コメント（「業績好調で割安」等） | + スコアの内訳 + 主要指標 | + 全指標 + チャートオーバーレイ |
| シグナル一覧 | 「買い時かも」「上昇トレンド開始」等の平易な表現 | + シグナル種別名 + 根拠指標 | + 複合シグナル + 信頼度スコア |
| セクターヒートマップ | 色のみ（赤=下落、緑=上昇） | + セクター名 + 騰落率 | + 資金フロー分析 + ローテーション提案 |
| 銘柄詳細 | 株価チャート + 簡易説明 | + PER/PBR等の主要指標 + 解説付き | + 全指標 + テクニカル指標重ね表示 |
| 週次レポート | 3行サマリー + 絵文字評価 | + セクター分析 + パフォーマンス詳細 | + 戦略提案 + 高度な分析 |

### 2.2 指標の段階的開放

#### Stage 1 で見せる指標
- **株価チャート**（ローソク足ではなくラインチャート）
- **変動率**（「今日は+2.5%上がりました」の形式）
- **配当利回り**（「年間で株価の3.5%分のお小遣いがもらえます」）
- **業績の方向性**（「売上が増えている会社です」程度）

#### Stage 2 で追加開放する指標
- **PER**（「この会社は利益の何倍の値段で売られているか」と解説付き）
- **PBR**（「会社の資産に対して株価が割安か」と解説付き）
- **RSI**（「買われすぎ/売られすぎを示すメーター」と解説付き）
- **移動平均線**（チャートへの重ね表示）
- **出来高**（「どれくらい活発に売買されているか」）
- **EPS成長率**（「1株あたりの利益がどれだけ伸びているか」）

#### Stage 3 で追加開放する指標
- **MACD**（トレンド転換の高度な指標）
- **ボリンジャーバンド**
- **フィボナッチリトレースメント**
- **セクター内相対強度**
- **複合スコアの重み付けカスタマイズ**
- **独自スクリーニング条件のフルエディタ**

### 2.3 用語の表示方式

| ステージ | 表示方式 | 例 |
|----------|----------|-----|
| Stage 1 | 専門用語は使わず平易な日本語のみ | 「この会社、お買い得かも！業績が良いのに株価が安めです」 |
| Stage 2 | 平易な説明 + カッコ内に専門用語 | 「お買い得度（PER）が業界平均より低く、割安です」 |
| Stage 3 | 専門用語メインで表示 | 「PER 12.3倍（業種平均18.5倍）、PBR 0.8倍」 |

---

## 3. 「なぜ？」の説明機能

### 3.1 シグナル理由の表示

すべてのシグナルと推奨に、ステージに応じた理由説明を付与する。

#### シグナル説明テンプレート

**Stage 1 向け（やさしい説明）**:
```
[シグナル] 買い時サイン！
[理由] この会社は最近業績が良いのに、株価がまだ安いままです。
       しかも、最近になって株を買う人が増え始めています。
       チャンスかもしれません。
[次のアクション] 気になったらウォッチリストに追加してみましょう
```

**Stage 2 向け（指標名付き説明）**:
```
[シグナル] 割安 + モメンタム転換
[理由] PERが業種平均（18.5倍）を大幅に下回る12.3倍で割安圏。
       さらに5日移動平均線が20日移動平均線を上抜け
       （ゴールデンクロス）し、上昇トレンドの兆しが見えます。
       出来高も平均の1.8倍に増加中。
[次のアクション] 詳細チャートを確認 → 購入を検討
```

**Stage 3 向け（データ重視）**:
```
[シグナル] バリュー+モメンタム複合シグナル（信頼度: 78%）
[根拠]
  - PER: 12.3x（業種avg 18.5x, σ: 4.2）
  - PBR: 0.82x
  - 5MA/20MAゴールデンクロス（本日発生）
  - RSI: 38→52（反転上昇中）
  - 出来高: 20日平均比1.8x
  - 過去の同条件シグナル勝率: 64%（n=47）
```

### 3.2 「もっと詳しく」ボタン

各シグナルや指標の横に「もっと詳しく」リンクを配置。タップすると：

1. **その指標が何を意味するか**（30秒で読める解説）
2. **なぜこの銘柄で注目に値するか**（具体的な数値と比較）
3. **過去にこのシグナルが出た銘柄はどうなったか**（成功/失敗の実例）

### 3.3 対話型Q&A「なぜ？」ボタン

推奨やシグナルに「なぜ？」ボタンを設置。タップすると対話形式で深掘りできる。

```
ユーザー: [なぜ？ボタンをタップ]
ツール: この銘柄をおすすめした理由は3つあります。
        1. 今の株価が会社の実力に対して安い（お買い得）
        2. 最近、買う人が増えてきている（人気が出始めた）
        3. 会社の業績が良くなっている（売上が前年比15%増）
        もっと知りたいポイントはありますか？
        [株価が安いってどういうこと？] [人気が出始めたって？] [業績について詳しく]
```

- Stage 1: 選択肢ベースの対話（自由入力不要）
- Stage 2: 選択肢 + 簡単な自由質問
- Stage 3: フル対話（任意の質問に回答）

---

## 4. 実践型学習の仕組み

### 4.1 判断振り返り機能

#### 4.1.1 「あのとき買っていたら」シミュレーション
- ウォッチリストに追加した時点の株価を記録
- 現在の株価と比較し、「もし買っていたら○○円の利益/損失」を表示
- **学び**: シグナルを無視した/従った結果を可視化し、判断の精度を振り返る

#### 4.1.2 週次の判断レビュー
週次レポート内に以下のセクションを追加：

```
### 今週の振り返り
- シグナルが出た銘柄: 5件
- そのうち実際に上昇した銘柄: 3件（的中率60%）
- あなたがウォッチリストに追加した銘柄: 2件
- そのうち上昇した銘柄: 1件

### 今週の学びポイント
「出来高が急増した銘柄は3件中2件が上昇しました。
 出来高は株価上昇の先行指標になることが多いです。」
```

#### 4.1.3 月次パフォーマンスレビュー
- その月のシグナル全体の成績を集計
- ユーザーが実際に取った行動（買った/見送った）と結果を対比
- 「もしすべてのシグナルに従っていたら」のシミュレーション結果
- 長期的なトレンドの振り返り（「3ヶ月前と比べて、あなたの判断精度は上がっています」）

### 4.2 ミニ学習カード

**シグナル発生時に「学びのひとこと」を添える**: 毎回ではなく、3回に1回程度の頻度で表示（疲れさせない）。

```
[学びのひとこと]
ゴールデンクロスとは、短期の株価平均が長期の平均を上回ること。
「最近の勢いが、長い目で見た流れを追い越した」サインです。
過去データでは、このサイン後に株価が上がった確率は約60%でした。
```

- **カード形式**: スワイプで閉じられる。読まなくてもペナルティなし
- **記録**: 閲覧済みカードの履歴を保存（ステージ昇格判定に利用）
- **復習**: 「学んだこと一覧」ページからいつでも再閲覧可能

### 4.3 シミュレーション売買（ペーパートレード）

Stage 1 ユーザー向けに、実際のお金を使わない練習モードを提供。

- **仮想資金**: 100万円の仮想資金でスタート
- **リアルタイム価格**: 実際の株価データを使用
- **操作**: 本番と同じUI。売買ボタンに「練習モード」ラベル
- **学び**: 実際に損益が出る体験を通じて、リスクとリターンの感覚を身につける
- **卒業条件**: 3ヶ月間のシミュレーションで通算プラスになれば「実践デビュー」を推奨
- **Stage 2以降**: ペーパートレードは引き続き利用可能（新しい戦略の試し打ちに）

### 4.4 成功/失敗パターンの自動分析

ユーザーの過去の行動から成功/失敗パターンを抽出し、フィードバックする。

```
[あなたの傾向分析]
- 得意パターン: 割安銘柄の発見（推奨銘柄の68%が上昇）
- 苦手パターン: モメンタム銘柄の売り時（利確が遅れて利益を減らすケースが多い）
- アドバイス: 「モメンタム銘柄は+10%で半分利確する」ルールを試してみませんか？
```

---

## 5. ゲーミフィケーション要素

### 5.1 投資家レベルシステム

ステージ内での成長を細かく可視化するレベルシステム。

| レベル | 名前 | 必要XP | ステージ |
|--------|------|--------|----------|
| 1 | 株の卵 | 0 | Stage 1 |
| 2 | 新芽の投資家 | 100 | Stage 1 |
| 3 | 歩き始めた投資家 | 300 | Stage 1 |
| 4 | 市場の探検家 | 600 | Stage 1 |
| 5 | 見習いトレーダー | 1000 | Stage 1→2 昇格ライン |
| 6 | 銘柄ハンター | 1500 | Stage 2 |
| 7 | チャート読み | 2200 | Stage 2 |
| 8 | シグナル使い | 3000 | Stage 2 |
| 9 | 戦略家の卵 | 4000 | Stage 2 |
| 10 | 独立投資家 | 5500 | Stage 2→3 昇格ライン |
| 11〜15 | （上級称号） | 7000〜 | Stage 3 |

### 5.2 XP（経験値）の獲得方法

| アクション | XP | 頻度制限 | 説明 |
|------------|-----|----------|------|
| ダッシュボードを開く | 5 | 1日1回 | 毎日チェックする習慣 |
| 銘柄詳細を確認する | 3 | 1日5回まで | 興味を持って調べる行動 |
| 「なぜ？」を閲覧 | 10 | 1日3回まで | 学ぶ意欲を評価 |
| 学習カードを閲覧 | 8 | カードごとに1回 | 知識を積み上げる |
| 週次レポートを閲覧 | 15 | 週1回 | 定期的な振り返り |
| シグナルが的中（ウォッチリスト銘柄） | 20 | 都度 | 成功体験 |
| 用語クイズに正解 | 10 | 問題ごとに1回 | 知識の定着 |
| シミュレーション売買を実行 | 5 | 1日3回まで | 実践練習 |
| スクリーニング条件をカスタマイズ | 25 | 初回のみ | 自立への第一歩 |
| 月次レビューを完了 | 30 | 月1回 | 長期の振り返り |
| 連続ログインボーナス | 3〜15 | 日数に応じて | 習慣化 |

### 5.3 実績バッジ

達成したマイルストーンを記録するバッジシステム。

#### 学習系バッジ
| バッジ名 | 条件 | アイコン案 |
|----------|------|------------|
| はじめの一歩 | 初回ダッシュボードアクセス | 足跡 |
| 知識の種 | 学習カード10枚閲覧 | 種 |
| 用語マスター（初級） | 基礎用語クイズ全問正解 | 本 |
| 用語マスター（中級） | 中級用語クイズ全問正解 | 辞書 |
| 質問上手 | 「なぜ？」を30回閲覧 | はてなマーク |

#### 行動系バッジ
| バッジ名 | 条件 | アイコン案 |
|----------|------|------------|
| ウォッチャー | ウォッチリスト5銘柄登録 | 双眼鏡 |
| 定点観測者 | 週次レポート10回連続閲覧 | 望遠鏡 |
| 早起き投資家 | 朝9時前にダッシュボードチェック10回 | 朝日 |
| 習慣の達人 | 30日連続ログイン | カレンダー |
| 練習の虫 | シミュレーション売買を30回実行 | ダンベル |

#### 成果系バッジ
| バッジ名 | 条件 | アイコン案 |
|----------|------|------------|
| 初めての利益 | シミュレーションまたは実際で初利益 | コイン |
| 目利き | シグナル的中率60%以上（10回以上） | ダーツ |
| 割安ハンター | 割安銘柄を発見し上昇を捉えた | 虫眼鏡 |
| トレンドサーファー | モメンタムシグナルで利益を得た | 波 |
| 配当コレクター | 配当銘柄を3つ以上保有 | 貯金箱 |
| 戦略家デビュー | 独自スクリーニング条件を作成・運用 | チェスの駒 |

### 5.4 連続ログインボーナス

| 連続日数 | ボーナスXP | 特典 |
|----------|-----------|------|
| 3日 | +10 | - |
| 7日 | +30 | 学習カード1枚アンロック |
| 14日 | +60 | 限定バッジ「2週間の継続」 |
| 30日 | +150 | 限定バッジ「習慣の達人」+ ステージ昇格判定 |
| 60日 | +300 | 限定バッジ「鉄の意志」 |

### 5.5 進捗ダッシュボード（プロフィール画面）

ユーザーの成長を可視化する専用画面。

- **現在のレベル・ステージ**: 大きく表示
- **次のレベルまでの進捗バー**: あとXP何ポイント
- **獲得済みバッジ一覧**: グリッド表示（未取得はシルエット）
- **学習カード閲覧率**: 全体の何%を学んだか
- **判断の精度推移グラフ**: 月ごとのシグナル的中率の推移
- **利用統計**: ログイン日数、閲覧した銘柄数、等

---

## 6. 教育機能に関する追加の機能要件

### High（MVP必須）

#### F-EO1: ステージ別UI表示制御
- **概要**: ユーザーのステージに応じて、ダッシュボード・詳細画面の情報量を自動制御
- **実装**: 各UI要素にステージ属性を付与し、現在ステージ以下のもののみ表示
- **ずぼら対応**: ユーザーは何も設定不要。ステージに応じて自動的に最適な情報量が表示される

#### F-EO2: シグナル理由テキスト生成
- **概要**: すべてのシグナルと推奨に、ステージ別の理由説明を自動生成
- **生成方式**: テンプレートベース + パラメータ埋め込み（Stage 1/2）、LLMベース（Stage 3のQ&A）
- **表示**: シグナル一覧・銘柄詳細画面にインライン表示

#### F-EO3: 学習カードシステム
- **概要**: シグナル発生時やレポート閲覧時に、コンテキストに応じたミニ学習カードを表示
- **カード数**: 初期50枚（基礎用語・チャートの読み方・指標の意味等）
- **表示頻度**: 3回に1回程度（ユーザーの閲覧履歴に応じて調整）
- **ずぼら対応**: 閉じるのは1スワイプ。読まなくてもツール利用に支障なし

#### F-EO4: XP・レベル・バッジシステム
- **概要**: ユーザー行動を追跡し、XPの付与・レベルアップ・バッジ付与を自動実行
- **表示**: ダッシュボードヘッダーにレベル表示。レベルアップ時にアニメーション通知
- **ずぼら対応**: 意識しなくても自然にXPが貯まる設計

### Medium（第2フェーズ）

#### F-EO5: 判断振り返り機能
- **概要**: 過去のシグナルとユーザーの行動（ウォッチリスト追加/無視）を記録し、結果を対比表示
- **表示**: 週次・月次レポート内の「振り返りセクション」
- **データ**: シグナル発生日、銘柄、当時の株価、現在の株価、ユーザーのアクション

#### F-EO6: シミュレーション売買（ペーパートレード）
- **概要**: 仮想資金100万円で実際の株価データを使った練習売買
- **対象**: 主にStage 1ユーザー（Stage 2以降も利用可能）
- **記録**: 売買履歴・損益を記録し、振り返りに活用

#### F-EO7: 用語クイズ
- **概要**: ステージ昇格判定に使用する投資用語の理解度テスト
- **形式**: 4択クイズ（10〜15問/セット）
- **内容**: Stage 1→2は基礎用語、Stage 2→3は中級指標の理解
- **ずぼら対応**: いつでも中断・再開可能。制限時間なし

#### F-EO8: 対話型Q&A
- **概要**: シグナルや推奨に対して「なぜ？」を深掘りできる対話インターフェース
- **Stage 1**: プリセット選択肢からの対話
- **Stage 2**: 選択肢 + 簡易自由入力
- **Stage 3**: フル対話（LLMベース）

### Low（将来拡張）

#### F-EO9: 成功/失敗パターン自動分析
- **概要**: ユーザーの判断傾向を統計的に分析し、得意/苦手パターンをフィードバック
- **必要データ**: 6ヶ月以上の行動履歴

#### F-EO10: コミュニティ学習（匿名）
- **概要**: 同じステージのユーザーの平均的な成績を匿名で共有し、モチベーションを維持
- **表示**: 「あなたと同じステージのユーザーの平均的中率は○%です」

---

## 7. データ設計（教育機能関連テーブル概要）

### user_stage テーブル
| カラム | 型 | 説明 |
|--------|-----|------|
| id | INTEGER PK | レコードID |
| user_id | INTEGER FK | ユーザーID |
| stage | INTEGER | 現在のステージ（1/2/3） |
| level | INTEGER | 現在のレベル（1〜15） |
| xp | INTEGER | 累計XP |
| stage_upgraded_at | DATETIME | 最後のステージ昇格日時 |
| self_declared_stage | INTEGER | 自己申告ステージ（NULLなら自動判定） |

### user_xp_log テーブル
| カラム | 型 | 説明 |
|--------|-----|------|
| id | INTEGER PK | ログID |
| user_id | INTEGER FK | ユーザーID |
| action_type | TEXT | アクション種別（dashboard_view, signal_why, quiz_correct等） |
| xp_earned | INTEGER | 獲得XP |
| created_at | DATETIME | 発生日時 |

### user_badges テーブル
| カラム | 型 | 説明 |
|--------|-----|------|
| id | INTEGER PK | レコードID |
| user_id | INTEGER FK | ユーザーID |
| badge_id | TEXT | バッジ識別子 |
| earned_at | DATETIME | 獲得日時 |

### learning_cards テーブル
| カラム | 型 | 説明 |
|--------|-----|------|
| id | INTEGER PK | カードID |
| card_key | TEXT | カード識別子 |
| title | TEXT | カードタイトル |
| content_stage1 | TEXT | Stage 1向けコンテンツ |
| content_stage2 | TEXT | Stage 2向けコンテンツ |
| content_stage3 | TEXT | Stage 3向けコンテンツ |
| related_signal_type | TEXT | 関連するシグナル種別 |
| category | TEXT | カテゴリ（用語/チャート/指標/戦略） |

### user_card_history テーブル
| カラム | 型 | 説明 |
|--------|-----|------|
| id | INTEGER PK | レコードID |
| user_id | INTEGER FK | ユーザーID |
| card_id | INTEGER FK | カードID |
| viewed_at | DATETIME | 閲覧日時 |

### simulation_trades テーブル
| カラム | 型 | 説明 |
|--------|-----|------|
| id | INTEGER PK | 取引ID |
| user_id | INTEGER FK | ユーザーID |
| ticker | TEXT | 銘柄コード |
| action | TEXT | buy / sell |
| price | REAL | 約定価格 |
| quantity | INTEGER | 数量 |
| virtual_balance | REAL | 取引後の仮想残高 |
| created_at | DATETIME | 取引日時 |

### signal_feedback テーブル
| カラム | 型 | 説明 |
|--------|-----|------|
| id | INTEGER PK | レコードID |
| user_id | INTEGER FK | ユーザーID |
| signal_id | INTEGER FK | シグナルID |
| user_action | TEXT | watched / ignored / bought |
| price_at_signal | REAL | シグナル発生時の株価 |
| price_after_7d | REAL | 7日後の株価 |
| price_after_30d | REAL | 30日後の株価 |
| is_success | BOOLEAN | 成功フラグ（7日後に上昇していればtrue） |

---

## 8. API エンドポイント概要（教育機能関連）

| メソッド | パス | 説明 |
|----------|------|------|
| GET | `/api/user/{id}/stage` | ユーザーのステージ・レベル・XP取得 |
| POST | `/api/user/{id}/xp` | XP加算（アクション記録） |
| GET | `/api/user/{id}/badges` | 獲得済みバッジ一覧 |
| GET | `/api/user/{id}/progress` | 成長ダッシュボード用データ |
| GET | `/api/learning/cards` | 学習カード一覧（ステージ別フィルタ） |
| POST | `/api/learning/cards/{id}/viewed` | カード閲覧記録 |
| GET | `/api/quiz/{stage}` | 用語クイズ取得 |
| POST | `/api/quiz/answer` | クイズ回答・結果記録 |
| GET | `/api/signal/{id}/explanation/{stage}` | シグナルのステージ別説明取得 |
| POST | `/api/signal/{id}/why` | 「なぜ？」対話の応答取得 |
| GET | `/api/simulation/portfolio/{user_id}` | シミュレーション用ポートフォリオ取得 |
| POST | `/api/simulation/trade` | シミュレーション売買実行 |
| GET | `/api/user/{id}/review/weekly` | 週次振り返りデータ |
| GET | `/api/user/{id}/review/monthly` | 月次振り返りデータ |
| GET | `/api/user/{id}/feedback/patterns` | 成功/失敗パターン分析 |

---

## 9. 既存機能との統合ポイント

### offense.md との連携
| 既存機能 | 教育的拡張 |
|----------|-----------|
| F-O1: 割安銘柄スクリーニング | Stage別の表示情報量制御 + 「なぜ割安か」の説明追加 |
| F-O2: モメンタムシグナル検知 | シグナル理由テキスト + 学習カード連動 |
| F-O3: ダッシュボード | ステージ別UI制御 + レベル/XP表示 |
| F-O4: 買い時通知 | 「なぜ今が買い時か」の説明付加 |
| F-O6: 銘柄スコアリング | Stage 1では総合スコアのみ、Stage 2で内訳表示、Stage 3で重み調整 |
| F-O7: 週次レポート | 判断振り返りセクション追加 |
| F-O8: バックテスト | Stage 3で開放。戦略検証の学習ツールとして位置づけ |

---

## 技術メモ

### ステージ別表示制御の実装方針
```python
# フロントエンド（Streamlit）でのステージ別表示制御
def show_signal(signal, user_stage):
    if user_stage == 1:
        st.write(signal.simple_description)  # 平易な説明
    elif user_stage == 2:
        st.write(signal.detailed_description)  # 指標名付き説明
        with st.expander("もっと詳しく"):
            st.write(signal.technical_detail)
    else:  # Stage 3
        st.write(signal.technical_description)  # フル情報
        st.json(signal.raw_data)
```

### XP管理の実装方針
```python
# XP加算はイベント駆動で実装
async def record_action(user_id: int, action_type: str):
    xp_map = {
        "dashboard_view": (5, "1/day"),
        "signal_why": (10, "3/day"),
        "card_viewed": (8, "per_card"),
        "weekly_report": (15, "1/week"),
        # ...
    }
    xp, limit = xp_map[action_type]
    if not exceeded_limit(user_id, action_type, limit):
        await add_xp(user_id, xp, action_type)
        await check_level_up(user_id)
        await check_badges(user_id)
```

### シグナル説明テンプレートの管理
- Stage 1/2: Jinjaテンプレート + パラメータ（高速・低コスト）
- Stage 3 Q&A: LLM API呼び出し（柔軟な対話。コスト管理のためキャッシュ活用）
