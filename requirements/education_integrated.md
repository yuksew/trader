# 教育機能 統合仕様書

## 0. 追加コンセプト

既存の「ずぼら × 低リスク」に以下を追加：

| 軸 | 意味 | ツールの対応 |
|-----|------|------------|
| **素人** | 用語がわからない、判断できない | 平易な言葉、段階的情報表示 |
| **育てる** | 自分で判断できるようになる | 実践型学習、レベルシステム、振り返り |

### 設計原則
- **実践ファースト**: 座学ではなく実際の投資行動の中で学ぶ
- **ジャストインタイム**: 必要なタイミングで必要な知識だけを提示
- **段階的開放**: 情報量とガードレールを段階的に調整
- **成功体験の蓄積**: 小さな成功を積み重ねて自信をつける
- **ずぼら互換**: 学ばなくてもツールは使える。学ぶとより上手く使える

---

## 1. 統合ステージシステム

攻めの3段階と守りの5段階を統合し、**4段階**に統一する。

| ステージ | 名称 | 攻めの状態 | 守りの状態 | ツールの振る舞い |
|----------|------|-----------|-----------|------------------|
| Lv.1 | **ビギナー** | 用語を知らない。推奨をそのまま受け入れ | リスクの概念がない | フルガード + 平易な表現のみ |
| Lv.2 | **気づき** | 基本用語を学び始めた | 「危険な状態がある」と認識 | ガイド付き自由 + 用語解説表示 |
| Lv.3 | **アクティブ** | 指標を理解し推奨理由が読める | リスク指標を理解し自分で判断可能 | 確認ベース + 全指標表示 |
| Lv.4 | **ストラテジスト** | 自分の戦略を持ちツールは参謀 | リスク管理が習慣化 | フルカスタム解放 |

### ステージ昇格条件

| 条件 | Lv.1→2 | Lv.2→3 | Lv.3→4 |
|------|---------|---------|---------|
| 累計利用日数 | 30日 | 90日 | 180日 |
| 「なぜ？」閲覧 | 3回 | 15回 | - |
| 用語解説閲覧 | 5種 | 15種 | - |
| 学習カード閲覧 | 10枚 | 30枚 | - |
| 週次レポート閲覧 | 5回 | 15回 | - |
| シミュレーション利用 | - | 3回 | - |
| スクリーニング条件カスタマイズ | - | - | 1回 |
| 損切りルールカスタマイズ | - | 1回 | - |
| 健全度スコア黄以上維持 | - | - | 3ヶ月 |
| 振り返りレポート確認 | - | 5回 | 10回 |

- **自動判定**: 行動ログから自動チェック（テスト不要＝ずぼら対応）
- **手動スキップ**: 初回設定で「経験者です」→ Lv.3からスタート可能
- **降格なし**: 一度上がったステージは下がらない

---

## 2. ステージ別 情報表示制御

### 2.1 ダッシュボード

| 表示要素 | Lv.1 | Lv.2 | Lv.3 | Lv.4 |
|----------|------|------|------|------|
| 健全度スコア | 信号機のみ | + 内訳バー | + 数値詳細 | + 全指標 |
| アラート | 平易な文 + 推奨アクション | + 根拠の簡易説明 | + 数値データ | + 計算式 |
| 注目銘柄 | 銘柄名 + 一言コメント | + スコア内訳 | + 全指標 | + カスタム |
| シグナル | 「買い時かも」等の平易表現 | + シグナル種別 | + 根拠データ | + 信頼度 |
| セクターマップ | 色のみ（赤=下落、緑=上昇） | + セクター名 + 騰落率 | + 資金フロー | + ローテーション |

### 2.2 用語の表示方式

| ステージ | 方式 | 例 |
|----------|------|-----|
| Lv.1 | 専門用語を使わず平易な日本語 | 「お買い得度が高い会社です」 |
| Lv.2 | 平易な説明 + カッコ内に専門用語 | 「お買い得度（PER）が業界平均より低い」 |
| Lv.3 | 専門用語 + ツールチップで解説 | 「PER 12.3倍（業種avg 18.5倍）」 |
| Lv.4 | 専門用語のみ | 「PER 12.3x / PBR 0.8x / DY 3.5%」 |

### 2.3 チャート表示の段階

| ステージ | チャート種類 |
|----------|-------------|
| Lv.1 | ラインチャートのみ |
| Lv.2 | + 移動平均線（解説付き） |
| Lv.3 | + ローソク足、RSI、出来高 |
| Lv.4 | + MACD、ボリンジャーバンド、全テクニカル |

---

## 3. ステージ別 ガードレール制御

| 機能 | Lv.1 | Lv.2 | Lv.3 | Lv.4 |
|------|------|------|------|------|
| 損切りライン | 自動-10%（変更不可） | 理由入力で変更可（-5%〜-20%） | 自由設定（-3%〜-30%） | フルカスタム |
| 集中度チェック | 30%超で購入ブロック | 30%超で確認ダイアログ | 40%超で警告のみ | 50%超で警告 |
| 健全度<40時 | 新規購入ブロック | 確認ダイアログ | 警告のみ | 情報表示のみ |
| 高ボラ銘柄 | 警告+確認必須 | 警告+「なぜ危険？」 | 情報表示 | 制限なし |
| 設定変更 | 不可 | 一部可能 | ほぼ全て可能 | 全て可能 |

### セーフティネット（全ステージ共通・無効化不可）
- Level 4（危険）アラートは常に通知
- ポートフォリオ全額が1銘柄の場合は常に警告
- 市場全体の暴落通知は常に有効
- 「セーフモード」ボタンで全ガードレールをONに戻せる

---

## 4. 用語解説システム

### 4.1 用語の平易な表現テーブル

| 専門用語 | Lv.1の表現 | 補足イメージ |
|----------|-----------|-------------|
| PER | お買い得度 | 「利益の何倍の値段か」 |
| PBR | 資産に対する割安度 | 「会社の持ち物に対して安いか」 |
| RSI | 買われすぎ/売られすぎメーター | 「温度計のようなもの」 |
| ボラティリティ | 値動きの激しさ | 「ジェットコースター度」 |
| ドローダウン | ピークからの下がり幅 | 「一番高い所からどれだけ落ちたか」 |
| シャープレシオ | リスクに見合ったリターンか | 「危険を冒した分だけ儲かっているか」 |
| β値 | 市場との連動度 | 「市場が風邪をひいた時の影響度」 |
| HHI | 偏り度合い | 「卵を一つのカゴに盛りすぎていないか」 |
| VaR | 最悪ケースの損失額 | 「運が悪い日の最大被害額」 |
| ゴールデンクロス | 上昇トレンドのサイン | 「最近の勢いが長期の流れを追い越した」 |
| 含み損 | 買った時より下がっている金額 | 「今売ったらこれだけ損する」 |
| 配当利回り | 年間のお小遣い率 | 「持っているだけでもらえる分」 |

### 4.2 用語集ページ
- 全用語をアルファベット/あいうえお順で一覧
- 検索機能付き
- ステージに応じて表示レベル自動切替
- 各用語から関連機能へのリンク

---

## 5. 「なぜ？」説明機能

### 5.1 攻めシグナルへの説明

各シグナルにステージ別の理由テンプレートを付与。

```python
SIGNAL_EXPLANATIONS = {
    "golden_cross": {
        1: "この銘柄、最近上がり始めています。買う人が増えてきたサインです。",
        2: "5日移動平均が20日移動平均を上抜け（ゴールデンクロス）しました。短期の勢いが長期トレンドを上回り、上昇トレンドの始まりを示唆しています。",
        3: "5MA/20MAゴールデンクロス発生。RSI={rsi}（中立圏から上昇中）、出来高は20日平均比{vol_ratio}倍。過去の同条件シグナル勝率: {win_rate}%（n={sample_size}）",
        4: "GC発生。5MA={ma5:.0f} > 20MA={ma20:.0f}。RSI(14)={rsi:.1f}。Vol ratio={vol_ratio:.1f}x。MACD histogram={macd_hist:.2f}。Historical win rate: {win_rate:.0f}% (n={sample_size})"
    },
    # ... 他のシグナル
}
```

### 5.2 守りアラートへの説明

W-01〜W-10の全アラートにステージ別の「なぜ危険？」テキストを付与。

### 5.3 「もっと詳しく」ボタン
- 30秒で読める解説
- その指標の意味 → この銘柄での具体的な数値 → 過去の類似事例

---

## 6. 実践型学習

### 6.1 ペーパートレード（仮想売買）
- 仮想資金100万円でスタート
- 実際の株価データを使用
- 本番と同じUI（「練習モード」ラベル付き）
- Lv.1で推奨、Lv.2以降も利用可能

### 6.2 シミュレーション
- **SIM-1**: 「もし損切りしなかったら」（損切りアラート時に提案）
- **SIM-2**: 「もし集中投資を続けたら」（集中リスク警告時に提案）
- **SIM-3**: 「リーマンショック級が来たら」（ストレステスト）
- **SIM-4**: 「分散の効果」（現状 vs 理想分散の比較）

### 6.3 振り返り機能
- **週次**: シグナル的中率、ユーザーの行動と結果
- **月次**: アラート対応率、「もし従っていたら」の試算
- **四半期**: 判断パターン分析、成長の可視化

### 6.4 学習カード
- シグナル/アラート発生時に3回に1回表示
- 初期50枚（用語・チャート読み方・指標の意味）
- スワイプで閉じられる（読まなくてもOK）
- 閲覧履歴を記録（ステージ昇格判定に利用）

---

## 7. ゲーミフィケーション

### 7.1 レベルシステム（15段階）

| レベル | 名前 | 必要XP | ステージ |
|--------|------|--------|----------|
| 1 | 株の卵 | 0 | Lv.1 |
| 2 | 新芽の投資家 | 100 | Lv.1 |
| 3 | 歩き始めた投資家 | 300 | Lv.1 |
| 4 | 市場の探検家 | 600 | Lv.1→2 |
| 5 | 見習いトレーダー | 1000 | Lv.2 |
| 6 | 銘柄ハンター | 1500 | Lv.2 |
| 7 | チャート読み | 2200 | Lv.2→3 |
| 8 | シグナル使い | 3000 | Lv.3 |
| 9 | 戦略家の卵 | 4000 | Lv.3 |
| 10 | 独立投資家 | 5500 | Lv.3→4 |
| 11-15 | 上級称号 | 7000〜 | Lv.4 |

### 7.2 XP獲得アクション

| アクション | XP | 頻度制限 |
|------------|-----|----------|
| ダッシュボードを開く | 5 | 1日1回 |
| 銘柄詳細を確認 | 3 | 1日5回 |
| 「なぜ？」を閲覧 | 10 | 1日3回 |
| 学習カードを閲覧 | 8 | カードごと1回 |
| 週次レポート閲覧 | 15 | 週1回 |
| シグナル的中 | 20 | 都度 |
| シミュレーション実行 | 5 | 1日3回 |
| 月次レビュー完了 | 30 | 月1回 |
| 連続ログイン | 3〜15 | 日数に応じ |

### 7.3 実績バッジ（16種）
- **学習系**: はじめの一歩、知識の種、用語マスター初級/中級、質問上手
- **行動系**: ウォッチャー、定点観測者、早起き投資家、習慣の達人、練習の虫
- **成果系**: 初めての利益、目利き、割安ハンター、トレンドサーファー、配当コレクター、戦略家デビュー

---

## 8. 追加データベーステーブル

### user_profile テーブル
| カラム | 型 | 説明 |
|--------|-----|------|
| id | INTEGER PK | ユーザーID |
| stage | INTEGER | 現在のステージ（1〜4）。デフォルト: 1 |
| level | INTEGER | 現在のレベル（1〜15）。デフォルト: 1 |
| xp | INTEGER | 累計XP。デフォルト: 0 |
| safe_mode | BOOLEAN | セーフモード有効フラグ。デフォルト: false |
| login_streak | INTEGER | 連続ログイン日数 |
| last_login_date | DATE | 最終ログイン日 |
| total_login_days | INTEGER | 累計ログイン日数 |
| stage_upgraded_at | DATETIME | 最終ステージ昇格日時 |
| self_declared_stage | INTEGER | 自己申告ステージ（NULL=自動判定） |
| created_at | DATETIME | 作成日時 |

### user_xp_log テーブル
| カラム | 型 | 説明 |
|--------|-----|------|
| id | INTEGER PK | ログID |
| user_id | INTEGER FK | ユーザーID |
| action_type | TEXT | アクション種別 |
| xp_earned | INTEGER | 獲得XP |
| created_at | DATETIME | 発生日時 |

### user_badges テーブル
| カラム | 型 | 説明 |
|--------|-----|------|
| id | INTEGER PK | レコードID |
| user_id | INTEGER FK | ユーザーID |
| badge_id | TEXT | バッジ識別子 |
| earned_at | DATETIME | 獲得日時 |

### learning_cards テーブル
| カラム | 型 | 説明 |
|--------|-----|------|
| id | INTEGER PK | カードID |
| card_key | TEXT UNIQUE | カード識別子 |
| title | TEXT | タイトル |
| content_lv1 | TEXT | Lv.1向け |
| content_lv2 | TEXT | Lv.2向け |
| content_lv3 | TEXT | Lv.3向け |
| content_lv4 | TEXT | Lv.4向け |
| category | TEXT | カテゴリ（term/chart/indicator/strategy/risk） |
| related_signal_type | TEXT | 関連シグナル種別 |

### user_card_history テーブル
| カラム | 型 | 説明 |
|--------|-----|------|
| id | INTEGER PK | レコードID |
| user_id | INTEGER FK | ユーザーID |
| card_id | INTEGER FK | カードID |
| viewed_at | DATETIME | 閲覧日時 |

### simulation_trades テーブル（ペーパートレード）
| カラム | 型 | 説明 |
|--------|-----|------|
| id | INTEGER PK | 取引ID |
| user_id | INTEGER FK | ユーザーID |
| ticker | TEXT | 銘柄コード |
| action | TEXT | buy/sell |
| price | REAL | 約定価格 |
| quantity | INTEGER | 数量 |
| virtual_balance | REAL | 取引後の仮想残高 |
| created_at | DATETIME | 取引日時 |

### signal_outcomes テーブル（シグナル追跡）
| カラム | 型 | 説明 |
|--------|-----|------|
| id | INTEGER PK | レコードID |
| signal_id | INTEGER FK | シグナルID |
| user_id | INTEGER FK | ユーザーID |
| user_action | TEXT | watched/ignored/bought |
| price_at_signal | REAL | シグナル時の株価 |
| price_after_7d | REAL | 7日後の株価 |
| price_after_30d | REAL | 30日後の株価 |
| is_success | BOOLEAN | 成功フラグ |

### alert_outcomes テーブル（アラート追跡）
| カラム | 型 | 説明 |
|--------|-----|------|
| id | INTEGER PK | レコードID |
| alert_id | INTEGER FK | アラートID |
| user_id | INTEGER FK | ユーザーID |
| user_action | TEXT | acted/ignored/read_only |
| action_detail | TEXT | 具体的な対応内容 |
| price_at_alert | REAL | アラート時の株価 |
| price_after_7d | REAL | 7日後の株価 |
| price_after_30d | REAL | 30日後の株価 |
| portfolio_impact | REAL | ポートフォリオ全体への影響額 |

### education_logs テーブル
| カラム | 型 | 説明 |
|--------|-----|------|
| id | INTEGER PK | ログID |
| user_id | INTEGER FK | ユーザーID |
| event_type | TEXT | イベント種別 |
| target_id | TEXT | 対象ID |
| context | TEXT | 発生画面 |
| created_at | DATETIME | 発生日時 |

### simulation_scenarios テーブル（What-Ifシミュレーション）
| カラム | 型 | 説明 |
|--------|-----|------|
| id | INTEGER PK | シミュレーションID |
| user_id | INTEGER FK | ユーザーID |
| scenario_type | TEXT | stop_loss/concentration/stress_test/diversification |
| parameters | TEXT | パラメータ（JSON） |
| result_summary | TEXT | 結果要約 |
| result_data | TEXT | 結果詳細（JSON） |
| created_at | DATETIME | 実行日時 |

---

## 9. 追加APIエンドポイント

### ユーザープロフィール・成長
| メソッド | パス | 説明 |
|----------|------|------|
| GET | `/api/user/profile` | ステージ・レベル・XP取得 |
| POST | `/api/user/xp` | XP加算 |
| GET | `/api/user/badges` | バッジ一覧 |
| GET | `/api/user/progress` | 成長ダッシュボード用データ |
| PUT | `/api/user/safe-mode` | セーフモード切替 |
| GET | `/api/user/guardrails` | 現在のガードレール設定 |

### 教育コンテンツ
| メソッド | パス | 説明 |
|----------|------|------|
| GET | `/api/glossary` | 用語一覧 |
| GET | `/api/glossary/{term}` | 個別用語解説 |
| GET | `/api/learning/cards` | 学習カード一覧 |
| POST | `/api/learning/cards/{id}/viewed` | カード閲覧記録 |
| GET | `/api/signals/{id}/explanation` | シグナルのステージ別説明 |
| GET | `/api/alerts/{id}/explanation` | アラートの「なぜ危険？」 |

### シミュレーション
| メソッド | パス | 説明 |
|----------|------|------|
| POST | `/api/simulation/paper-trade` | ペーパートレード実行 |
| GET | `/api/simulation/paper-portfolio` | ペーパーポートフォリオ取得 |
| POST | `/api/simulation/what-if` | What-Ifシミュレーション実行 |
| GET | `/api/simulation/{id}/result` | シミュレーション結果 |

### 振り返り
| メソッド | パス | 説明 |
|----------|------|------|
| GET | `/api/review/weekly` | 週次振り返り |
| GET | `/api/review/monthly` | 月次振り返り |
| GET | `/api/signals/{id}/outcome` | シグナルの結果追跡 |
| GET | `/api/alerts/{id}/outcome` | アラートの結果追跡 |

---

## 10. 開発タスク割り振り

### strategy-dev
- `src/strategy/explanations.py`（新規）: シグナル・アラートのステージ別説明テンプレート
- `src/strategy/education.py`（新規）: XP管理、ステージ判定、バッジ判定ロジック
- `src/strategy/simulation.py`（新規）: What-Ifシミュレーション（損切り/集中/ストレステスト/分散）
- 既存の `signals.py`, `alerts.py` に説明テキスト生成メソッドを追加

### backend-dev
- `src/api/database.py` に教育関連テーブルを追加
- `src/api/routers/education.py`（新規）: 教育API（プロフィール、XP、バッジ、用語集、学習カード）
- `src/api/routers/simulation.py`（新規）: シミュレーションAPI（ペーパートレード、What-If）
- `src/api/routers/review.py`（新規）: 振り返りAPI
- `src/api/models.py` にeducation関連のPydanticモデルを追加

### frontend-dev
- `src/ui/pages/learning.py`（新規）: 学習ページ（用語集、学習カード一覧、クイズ）
- `src/ui/pages/profile.py`（新規）: プロフィール（レベル、バッジ、成長グラフ）
- `src/ui/pages/simulation.py`（新規）: シミュレーション画面
- `src/ui/components/stage_indicator.py`（新規）: ステージ・レベル表示
- `src/ui/components/learning_card.py`（新規）: 学習カード表示
- `src/ui/components/explanation_popup.py`（新規）: 「なぜ？」ポップアップ
- 既存ページにステージ別表示制御を追加（dashboard.py, portfolio.py, screening.py）

### ダッシュボード画面の変更

```
┌─────────────────────────────────────────────────┐
│ 🎓 Lv.3 アクティブ (XP: 2450/3000)  [===========---]  │  ← NEW: レベル表示
├─────────────────────────────────────────────────┤
│ 🚦 ポートフォリオ健全度: 72/100 [緑]            │
│    「健全です。特にアクションは不要です」          │
│    [なぜこのスコア？]                             │  ← NEW: なぜ？ボタン
├─────────────────────────────────────────────────┤
│ ⚠️ アラート (2件)                                │
│  [黄] A社が取得価格から-8%下落中                  │
│       [なぜ危険？] [シミュレーション]              │  ← NEW: 説明+シミュ
├─────────────────────────────────────────────────┤
│ 📈 今日の注目銘柄 TOP5                           │
│  1. B社 (スコア: 85) - 上がり始めています         │  ← Lv.1: 平易な表現
│     [なぜ注目？]                                  │  ← NEW: なぜ？ボタン
├─────────────────────────────────────────────────┤
│ 💡 学習カード                                     │  ← NEW: 学習カード
│  「ゴールデンクロスって何？」                      │
│  短期の平均が長期を上回った時のこと。[×閉じる]    │
├─────────────────────────────────────────────────┤
│ 💼 ポートフォリオ     │ 🗂️ セクター構成          │
│  ...                  │  ...                      │
└─────────────────────────────────────────────────┘
```
