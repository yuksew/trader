# 守りの要件定義書

## 概要

本ドキュメントは「ずぼら×低リスク」株式投資ツール（traders-tool）における**守りの視点**からの要件を定義する。ユーザーが放置していても資産が守られ、損失リスクが最小化される仕組みを構築することを目的とする。

---

## 1. ユーザーストーリー（ずぼらユーザーが遭遇するリスクシーン）

### US-D1: 気づかぬ暴落
> 「仕事が忙しくて2週間チャートを見ていなかったら、保有銘柄が20%も下がっていた。もっと早く知りたかった。」

### US-D2: 集中投資の罠
> 「好きな企業の株を買い増していたら、ポートフォリオの60%が1銘柄になっていた。その銘柄が決算ミスで急落し、全体が大きく毀損した。」

### US-D3: セクター偏り
> 「テック株ばかり持っていたら、金利上昇局面でポートフォリオ全体が一斉に下がった。分散できていると思っていたのに。」

### US-D4: 塩漬け放置
> 「損切りできず半年放置していた銘柄が、さらに下がり続けて含み損が膨らんだ。最初に損切りルールを決めておけばよかった。」

### US-D5: 高ボラティリティ銘柄の保有
> 「値動きが激しい銘柄を何となく持ち続けていたら、精神的にもきつく、結局安値で売ってしまった。」

### US-D6: 市場全体の下落トレンド見逃し
> 「個別銘柄だけ見ていて、市場全体が下落トレンドに入っていたことに気づかなかった。キャッシュ比率を上げるべきだった。」

---

## 2. 注目指標

| 指標 | 説明 | 用途 | 取得方法 |
|------|------|------|----------|
| **ボラティリティ（標準偏差）** | 株価のばらつき度合い | 個別銘柄のリスク評価 | yfinanceの日次リターンから算出（20日/60日） |
| **最大ドローダウン（MDD）** | ピークからの最大下落率 | ポートフォリオ全体の最悪ケース把握 | 累積リターンのピークと谷から算出 |
| **シャープレシオ** | リスク対比のリターン効率 | リスクに見合ったリターンか判定 | (リターン - 無リスク金利) / 標準偏差 |
| **相関係数** | 銘柄間の値動きの連動性 | 分散効果の確認 | 銘柄ペアの日次リターン相関 |
| **β値（ベータ）** | 市場全体との連動性 | 市場下落時の影響度予測 | 個別銘柄 vs 市場インデックスの回帰分析 |
| **集中度（HHI）** | ポートフォリオの偏り度合い | 分散不足の検出 | 各銘柄のウェイトの2乗和 |
| **VaR（バリューアットリスク）** | 一定信頼水準での最大予想損失 | 最悪ケースの金額把握 | ヒストリカル法で算出（95%/99%） |
| **含み損率** | 取得価格からの下落率 | 損切り判定 | (現在価格 - 取得価格) / 取得価格 |
| **連続下落日数** | 何日連続で下がっているか | 異常な下落トレンドの検出 | 日次リターンの符号を追跡 |

---

## 3. 機能要件

### High（必須）

#### F-D1: 損切りアラート
- **概要**: 保有銘柄が設定した閾値以上下落した場合に自動通知
- **デフォルト閾値**: 取得価格から-10%、-15%、-20%の3段階
- **通知方法**: ダッシュボード上の警告バナー + メール通知（設定時）
- **ずぼら対応**: デフォルト閾値がプリセットされており、設定不要で即時稼働

#### F-D2: ポートフォリオ健全度スコア
- **概要**: ポートフォリオ全体のリスク状態を0〜100のスコアで表示
- **構成要素**:
  - 分散度スコア（集中度の逆数ベース）: 30%
  - ボラティリティスコア（過去60日の標準偏差ベース）: 25%
  - ドローダウンスコア（MDD小さいほど高得点）: 20%
  - 相関スコア（銘柄間相関が低いほど高得点）: 15%
  - 含み損スコア（含み損銘柄が少ないほど高得点）: 10%
- **表示**: ダッシュボードトップに常時表示（信号機方式: 緑/黄/赤）
  - 70〜100: 緑（健全）
  - 40〜69: 黄（注意）
  - 0〜39: 赤（危険）
- **ずぼら対応**: ログインするだけで一目でリスク状態がわかる

#### F-D3: 集中リスク警告
- **概要**: 特定銘柄またはセクターへの偏りが閾値を超えた場合に警告
- **閾値**:
  - 単一銘柄: ポートフォリオの30%以上で警告
  - 単一セクター: ポートフォリオの50%以上で警告
- **表示**: ポートフォリオ画面にて視覚的にハイライト
- **ずぼら対応**: 買い増し時に自動で集中度をチェックし、閾値超え時は確認ダイアログ表示

#### F-D4: 暴落アラート（急落検知）
- **概要**: 保有銘柄または市場インデックスの急激な下落を検知し通知
- **検知条件**:
  - 個別銘柄: 1日で-5%以上の下落
  - 市場インデックス（日経225/S&P500）: 1日で-3%以上の下落
  - 保有銘柄の50%以上が同日に下落: 市場全体のリスクとして通知
- **ずぼら対応**: バックグラウンドで定期チェック（1日1回自動実行）

### Medium（推奨）

#### F-D5: リスク日次サマリー
- **概要**: 毎日の市場クローズ後にポートフォリオのリスクサマリーを自動生成
- **内容**: 日次損益、健全度スコアの変化、注意が必要な銘柄リスト
- **配信**: ダッシュボードのサマリーセクションに表示
- **ずぼら対応**: 見に行かなくてもプッシュ通知対応可能（将来拡張）

#### F-D6: 分散度チェッカー
- **概要**: ポートフォリオの分散状況を視覚的に分析
- **表示内容**:
  - セクター別構成比（円グラフ）
  - 相関マトリクス（ヒートマップ）
  - 効率的フロンティア上の現在位置
- **推奨アクション**: 分散不足の場合、改善の方向性を提示

#### F-D7: 損切りルール自動設定
- **概要**: 銘柄購入時に自動で損切りラインを設定
- **デフォルト**: 取得価格の-10%（変更可能）
- **トレーリングストップ対応**: 株価上昇に合わせて損切りラインも引き上げ
- **ずぼら対応**: 「おまかせ」モードで全銘柄に一括適用

#### F-D8: β値ベースの市場感応度表示
- **概要**: 各銘柄のβ値を算出し、市場下落時の影響度を表示
- **表示**: 銘柄一覧にβ値カラムを追加、β>1.5の銘柄をハイライト
- **活用**: 市場全体の下落局面で大きく影響を受ける銘柄を把握

### Low（将来対応）

#### F-D9: VaRレポート
- **概要**: ポートフォリオ全体のVaRを日次で算出・表示
- **手法**: ヒストリカル法（過去1年のデータ、95%信頼水準）
- **表示**: 「最悪の場合、1日で○○円の損失が想定されます」形式

#### F-D10: リバランスアラート
- **概要**: 当初設定した目標配分から大きくずれた場合に通知
- **閾値**: 目標配分から±10%以上の乖離
- **ずぼら対応**: リバランス対象と推奨アクションを具体的に提示

#### F-D11: マクロリスクモニター
- **概要**: VIX指数、金利、為替など市場全体のリスク指標を監視
- **閾値**: VIX>25で注意、VIX>35で警戒
- **ずぼら対応**: 普段は非表示、閾値超えで自動的にダッシュボードに表示

---

## 4. 警告ルール

### 4.1 警告レベル定義

| レベル | 名称 | 色 | 対応 |
|--------|------|----|------|
| Level 1 | 情報 | 青 | 参考情報として表示。ユーザーアクション不要 |
| Level 2 | 注意 | 黄 | 確認を推奨。ダッシュボードにバッジ表示 |
| Level 3 | 警告 | オレンジ | 対応を推奨。目立つバナーで通知 |
| Level 4 | 危険 | 赤 | 即時対応を推奨。全画面アラート + メール通知 |

### 4.2 警告トリガー一覧

| ID | トリガー条件 | レベル | 通知内容 |
|----|-------------|--------|----------|
| W-01 | 個別銘柄が-5%/日 | Level 2 | 「{銘柄}が本日{X}%下落しました」 |
| W-02 | 個別銘柄が-10%（取得価格比） | Level 3 | 「{銘柄}が取得価格から{X}%下落。損切りラインに接近中」 |
| W-03 | 個別銘柄が-15%（取得価格比） | Level 4 | 「{銘柄}が損切り推奨ラインを突破。対応を検討してください」 |
| W-04 | 健全度スコア < 40 | Level 4 | 「ポートフォリオの健全度が危険水準です（スコア: {X}）」 |
| W-05 | 健全度スコア < 70 | Level 2 | 「ポートフォリオの健全度が注意水準です（スコア: {X}）」 |
| W-06 | 単一銘柄の比率 > 30% | Level 3 | 「{銘柄}がポートフォリオの{X}%を占めています。集中リスクに注意」 |
| W-07 | 単一セクターの比率 > 50% | Level 3 | 「{セクター}セクターがポートフォリオの{X}%を占めています」 |
| W-08 | 市場インデックス -3%/日 | Level 3 | 「市場全体が大幅下落中。保有銘柄への影響を確認してください」 |
| W-09 | 保有銘柄の50%以上が同日下落 | Level 3 | 「保有銘柄の過半数が下落中。ポートフォリオ全体を確認してください」 |
| W-10 | 含み損銘柄が30日以上放置 | Level 2 | 「{銘柄}の含み損が{X}日間継続中。損切り/ナンピンの検討を」 |

### 4.3 通知頻度制御

- **同一銘柄への同一レベル警告**: 24時間に1回まで（通知疲れ防止）
- **Level 4（危険）**: 状態が解消されるまで毎日通知
- **Level 1〜2**: ダッシュボードのみ。プッシュ通知は送らない
- **一括ミュート機能**: 旅行中などに全通知を一時停止可能（最大30日）

---

## 5. 「ずぼら」対応の工夫

### 5.1 ゼロコンフィグ設計
- **初期設定不要**: デフォルト値で全機能が稼働
  - 損切りライン: -10%（自動設定）
  - 集中度閾値: 単一銘柄30%、セクター50%
  - 健全度スコア: 自動算出
- **おまかせモード**: 全設定をデフォルトのまま使える「おまかせ」ボタン

### 5.2 放置しても安全な仕組み
- **自動日次チェック**: バッチ処理で毎日1回、全指標を自動チェック
  - 実装: FastAPIのバックグラウンドタスク or スケジューラ（APScheduler）
  - チェック時刻: 市場クローズ後（日本市場: 16:00 JST、米国市場: 翌7:00 JST）
- **段階的エスカレーション**: 放置するほど警告レベルが上がる
  - 含み損-10%放置→7日後にLevel 2→14日後にLevel 3→30日後にLevel 4
- **長期未ログイン警告**: 7日以上ログインなしの場合、サマリーメール送信

### 5.3 情報の簡素化
- **信号機UI**: 緑/黄/赤の3色で直感的にリスクを把握
- **ワンライン要約**: 各警告に「何をすべきか」を1行で表示
  - 例: 「A社を一部売却して分散度を改善しましょう」
- **詳細は折りたたみ**: 数値やグラフは「詳細を見る」で展開（デフォルトは非表示）

### 5.4 防御的デフォルト
- **新規購入時の自動チェック**: 買い付け前に集中度・相関をチェック
  - 「この銘柄を買うとセクター偏りが55%になります。続けますか？」
- **損切りルール自動適用**: 銘柄追加時にデフォルト損切りラインを自動設定
- **健全度低下時の買い付け制限**: 健全度スコアが赤（<40）の場合、新規買い付け前に確認ダイアログ

### 5.5 通知疲れ対策
- **重要度フィルタリング**: Level 3以上のみプッシュ通知（デフォルト）
- **日次ダイジェスト**: 細かい通知は1日1回のダイジェストにまとめる
- **自動解消**: 株価回復で警告が自動的に解除される

---

## 6. データ設計（関連テーブル概要）

### alerts テーブル
| カラム | 型 | 説明 |
|--------|-----|------|
| id | INTEGER PK | アラートID |
| portfolio_id | INTEGER FK | ポートフォリオID |
| ticker | TEXT | 銘柄コード |
| alert_type | TEXT | アラート種別（W-01〜W-10） |
| level | INTEGER | 警告レベル（1〜4） |
| message | TEXT | 通知メッセージ |
| is_read | BOOLEAN | 既読フラグ |
| is_resolved | BOOLEAN | 解消フラグ |
| created_at | DATETIME | 作成日時 |
| resolved_at | DATETIME | 解消日時 |

### risk_metrics テーブル
| カラム | 型 | 説明 |
|--------|-----|------|
| id | INTEGER PK | メトリクスID |
| portfolio_id | INTEGER FK | ポートフォリオID |
| date | DATE | 算出日 |
| health_score | REAL | 健全度スコア（0〜100） |
| max_drawdown | REAL | 最大ドローダウン |
| portfolio_volatility | REAL | ポートフォリオ全体のボラティリティ |
| sharpe_ratio | REAL | シャープレシオ |
| hhi | REAL | 集中度指数 |
| var_95 | REAL | 95% VaR |

### stop_loss_rules テーブル
| カラム | 型 | 説明 |
|--------|-----|------|
| id | INTEGER PK | ルールID |
| portfolio_id | INTEGER FK | ポートフォリオID |
| ticker | TEXT | 銘柄コード |
| buy_price | REAL | 取得価格 |
| stop_loss_pct | REAL | 損切り閾値（%） |
| trailing_stop | BOOLEAN | トレーリングストップ有効フラグ |
| highest_price | REAL | 最高値（トレーリング用） |
| is_active | BOOLEAN | 有効フラグ |

---

## 7. API エンドポイント概要

| メソッド | パス | 説明 |
|----------|------|------|
| GET | `/api/portfolio/{id}/health` | 健全度スコア取得 |
| GET | `/api/portfolio/{id}/alerts` | アラート一覧取得 |
| PUT | `/api/alerts/{id}/read` | アラート既読化 |
| GET | `/api/portfolio/{id}/risk-metrics` | リスク指標取得 |
| GET | `/api/portfolio/{id}/concentration` | 集中度分析取得 |
| GET | `/api/portfolio/{id}/correlation` | 相関マトリクス取得 |
| POST | `/api/portfolio/{id}/stop-loss` | 損切りルール設定 |
| PUT | `/api/portfolio/{id}/stop-loss/{ticker}` | 損切りルール更新 |
| POST | `/api/risk-check/daily` | 日次リスクチェック実行 |
| GET | `/api/portfolio/{id}/summary` | リスク日次サマリー取得 |
